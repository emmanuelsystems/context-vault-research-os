// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// PRD v2 Status: draft → in_progress → judged → banked
// PRD v2 Stake: low | medium | high
model Run {
  id               String            @id
  title            String
  primary_question String
  domain           String
  stake_level      String            @default("medium") // low | medium | high
  status           String            @default("draft") // draft | in_progress | judged | banked
  owner_user_id    String
  approver_user_id String?
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  artifacts        RunArtifact[]
  receipts         DecisionReceipt[]
  context_links    RunContextLink[]

  @@index([status])
  @@index([domain])
  @@index([stake_level])
}

// PRD v2 Artifact Types: HS, PM, RC, RP, RL, DT
model RunArtifact {
  id             String   @id @default(uuid())
  run_id         String
  run            Run      @relation(fields: [run_id], references: [id])
  artifact_type  String // HS | PM | RC | RP | RL | DT
  status         String   @default("draft") // draft | approved | final
  payload        String // JSON payload
  schema_version String   @default("v1.0")
  content_ref    String? // URL or blob id for external content
  links          String? // JSON array of refs: source_ids, artifact_ids
  tags           String? // JSON array: {User Stated} | {Inference} | {Assumption}
  created_by     String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  engine         String? // For RP/PM
  container      String? // For RP/PM

  @@index([run_id])
  @@index([artifact_type])
}

// PRD v2 Decision Receipts - emitted at commit points
// Commit Points: HS_LOCKED | PATH_SELECTED | CHARTER_APPROVED | FINAL_DECISION_COMMITTED
model DecisionReceipt {
  id              String   @id @default(uuid())
  run_id          String
  run             Run      @relation(fields: [run_id], references: [id])
  commit_point    String // HS_LOCKED | PATH_SELECTED | CHARTER_APPROVED | FINAL_DECISION_COMMITTED
  summary         String?
  inputs          String? // JSON array
  constraints     String? // JSON array
  decision_makers String? // JSON array
  outcome         String?
  actions         String? // JSON array
  follow_up       String? // JSON array
  confidence      Float?
  approvals       String? // JSON array: [{name, role, approved_at}]
  evidence_links  String? // JSON array: points to RL entries
  dt_artifact_id  String? // Reference to the DT artifact at this point
  created_at      DateTime @default(now())

  @@unique([run_id, commit_point])
  @@index([run_id])
  @@index([commit_point])
}

// Context Vault Memory Items
// Layers: RAW | SENSEMAKING | STRUCTURED | APPLICATION
model ContextItem {
  id           String   @id @default(uuid())
  layer        String // RAW | SENSEMAKING | STRUCTURED | APPLICATION
  source_type  String? // voice | transcript | note | research_dump | interview | other
  title        String?
  project      String?
  people       String? // JSON array of strings
  topics       String? // JSON array of strings
  occurred_at  DateTime?

  // Raw content may be stored inline for MVP; later we can move to content_ref
  content_text String?
  content_ref  String? // URL or blob id for external content
  payload      String? // JSON metadata (extensible, additive)

  created_by   String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  run_links    RunContextLink[]

  @@index([layer])
  @@index([project])
  @@index([occurred_at])
}

// Many-to-many between Runs and ContextItems (memory inputs reused across runs)
model RunContextLink {
  id              String      @id @default(uuid())
  run_id          String
  run             Run         @relation(fields: [run_id], references: [id])
  context_item_id String
  context_item    ContextItem @relation(fields: [context_item_id], references: [id])
  created_at      DateTime    @default(now())

  @@unique([run_id, context_item_id])
  @@index([run_id])
  @@index([context_item_id])
}
